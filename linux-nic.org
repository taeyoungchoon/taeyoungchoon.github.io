* and more like vlan and bridge
  
#+BEGIN_SRC emacs-lisp
(setf bonding '(nic1 nic2))
(cons (cons bonding 'vlan) 'bridge)
#+END_SRC

#+RESULTS:
: (((nic1 nic2) . vlan) . bridge)

* ip alias
* bonding

- /proc/net/bond/bond0

* type of bond

- active standby
- active active support by switch

** active active support by switch

*** support by cisco
*** support by juniper
* bonding then teaming
* DONE vlan

- /proc/net/vlan/config
- vi /etc/sysconfig/network-scripts/ifcfg-eth0.5
- DEVICE=eth0.5
- VLAN=yes

** using file

#+BEGIN_SRC 
# cat ifcfg-p1p1
DEVICE=p1p1
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
#+END_SRC

#+BEGIN_SRC 
# cat ifcfg-p1p1.101 
DEVICE=p1p1.101
BOOTPROTO=none
ONBOOT=yes
IPADDR=172.16.0.184
PREFIX=24
VLAN=yes
#+END_SRC

** using ip cli

#+BEGIN_SRC 
# ip link add link eth0 name eth0.5 type vlan id 5
# ip link
# ip -d link show eth0.5
#+END_SRC

#+BEGIN_SRC 
# ip addr add 192.168.1.200/24 brd 192.168.1.255 dev eth0.5
# ip link set dev eth0.5 up
#+END_SRC

#+BEGIN_SRC 
# ip link set dev eth0.5 down
# ip link delete eth0.5
#+END_SRC

* more, USERCTL=no
* more, vconfig

- yum install epel-release
- yum install vconfig
- apt install vlan

* more, NM_CONTROLLED="no"

- systemctl disable NetworkManager

#+BEGIN_SRC 
# nmcli 
Error: NetworkManager is not running.
#+END_SRC

* more, disable ipv6

** /etc/sysconfig/network-scripts/ifcfg-eth0

IPV6INIT=no
IPV6_AUTOCONF=no

** /etc/sysconfig/network

NETWORKING_IPV6=no
IPV6_AUTOCONF=no

* DONE bonding from centos7

#+BEGIN_SRC 
[root@s003 ~]# ls
anaconda-ks.cfg      ifcfg-bond0_slave_2      ifcfg-enp3s0f0  ifcfg-enp4s0f0  ifcfg-lo
ifcfg-bond0_slave_1  ifcfg-Bond_connection_1  ifcfg-enp3s0f1  ifcfg-enp4s0f1  initial-setup-ks.cfg
[root@s003 ~]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp3s0f0: <BROADCAST,MULTICAST> mtu 1500 qdisc mq state DOWN group default qlen 1000
    link/ether 10:60:4b:9c:a2:a4 brd ff:ff:ff:ff:ff:ff
3: enp3s0f1: <BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP> mtu 1500 qdisc mq master bond0 state UP group default qlen 1000
    link/ether 10:60:4b:9c:a2:a4 brd ff:ff:ff:ff:ff:ff
4: enp4s0f0: <BROADCAST,MULTICAST> mtu 1500 qdisc mq state DOWN group default qlen 1000
    link/ether 10:60:4b:9c:a2:b8 brd ff:ff:ff:ff:ff:ff
5: enp4s0f1: <BROADCAST,MULTICAST> mtu 1500 qdisc mq state DOWN group default qlen 1000
    link/ether 10:60:4b:9c:a2:ba brd ff:ff:ff:ff:ff:ff
6: virbr0: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc noqueue state DOWN group default qlen 1000
    link/ether 52:54:00:57:1d:35 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
7: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc pfifo_fast master virbr0 state DOWN group default qlen 1000
    link/ether 52:54:00:57:1d:35 brd ff:ff:ff:ff:ff:ff
11: bond0: <BROADCAST,MULTICAST,MASTER,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 10:60:4b:9c:a2:a4 brd ff:ff:ff:ff:ff:ff
    inet 192.168.25.118/24 brd 192.168.25.255 scope global bond0
       valid_lft forever preferred_lft forever
    inet6 fe80::1260:4bff:fe9c:a2a4/64 scope link
       valid_lft forever preferred_lft forever
#+END_SRC

#+BEGIN_SRC 
[root@s003 ~]# cat /etc/sysconfig/network-scripts/ifcfg-bond0_slave_1
HWADDR=10:60:4B:9C:A2:A4
TYPE=Ethernet
NAME="bond0 slave 1"
UUID=52b7d974-4714-474a-b8c5-074b7bb471df
DEVICE=enp3s0f0
ONBOOT=yes
MASTER=bond0
SLAVE=yes

[root@s003 ~]# cat /etc/sysconfig/network-scripts/ifcfg-bond0_slave_2
HWADDR=10:60:4B:9C:A2:A6
TYPE=Ethernet
NAME="bond0 slave 2"
UUID=39b7835a-fce5-474a-b586-95814feeeff5
DEVICE=enp3s0f1
ONBOOT=yes
MASTER=bond0
SLAVE=yes

[root@s003 ~]# cat /etc/sysconfig/network-scripts/ifcfg-Bond_connection_1
BONDING_OPTS="downdelay=0 miimon=1 mode=active-backup updelay=0 primary=enp3s0f0"
TYPE=Bond
BONDING_MASTER=yes
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=none
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_PRIVACY=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME="Bond connection 1"
UUID=1e2ed45c-2273-4e3c-8ec8-6f7519f78280
DEVICE=bond0
ONBOOT=yes
IPADDR=192.168.25.118
PREFIX=24
GATEWAY=192.168.25.1

[root@s003 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp3s0f0
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=enp3s0f0
UUID=e0f2a559-7279-4c99-9f43-ebe4525f45ad
DEVICE=enp3s0f0
ONBOOT=no

[root@s003 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp3s0f1
TYPE=Ethernet
PROXY_METHOD=none
BROWSER_ONLY=no
BOOTPROTO=dhcp
DEFROUTE=yes
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=enp3s0f1
UUID=b94d3c5a-116e-4b2d-b654-aea79dea3144
DEVICE=enp3s0f1
ONBOOT=no
#+END_SRC

#+BEGIN_SRC 
[root@s003 ~]# systemctl is-enabled NetworkManager
disabled
[root@s003 ~]# systemctl is-active NetworkManager
inactive

[root@s003 ~]# systemctl status network
● network.service - LSB: Bring up/down networking
   Loaded: loaded (/etc/rc.d/init.d/network; bad; vendor preset: disabled)
   Active: active (exited) since Tue 2022-03-22 21:11:36 EDT; 29min ago
     Docs: man:systemd-sysv-generator(8)
  Process: 18036 ExecStop=/etc/rc.d/init.d/network stop (code=exited, status=0/SUCCESS)
  Process: 18371 ExecStart=/etc/rc.d/init.d/network start (code=exited, status=0/SUCCESS)
    Tasks: 0

Mar 22 21:11:31 s003.t.com systemd[1]: Starting LSB: Bring up/down networking...
Mar 22 21:11:31 s003.t.com network[18371]: Bringing up loopback interface:  [  OK  ]
Mar 22 21:11:36 s003.t.com network[18371]: Bringing up interface Bond_connection_1:  [  OK  ]
Mar 22 21:11:36 s003.t.com systemd[1]: Started LSB: Bring up/down networking.
#+END_SRC

#+BEGIN_SRC 
[root@s003 ~]# cat /proc/net/bonding/bond0
Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)

Bonding Mode: fault-tolerance (active-backup)
Primary Slave: None
Currently Active Slave: enp3s0f1
MII Status: up
MII Polling Interval (ms): 1
Up Delay (ms): 0
Down Delay (ms): 0

Slave Interface: enp3s0f1
MII Status: up
Speed: 1000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 10:60:4b:9c:a2:a6
Slave queue ID: 0
[root@s003 ~]# ifenslave bond0 enp3s0f0
[root@s003 ~]# cat /proc/net/bonding/bond0
Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)

Bonding Mode: fault-tolerance (active-backup)
Primary Slave: enp3s0f0 (primary_reselect always)
Currently Active Slave: enp3s0f0
MII Status: up
MII Polling Interval (ms): 1
Up Delay (ms): 0
Down Delay (ms): 0

Slave Interface: enp3s0f1
MII Status: up
Speed: 1000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 10:60:4b:9c:a2:a6
Slave queue ID: 0

Slave Interface: enp3s0f0
MII Status: up
Speed: 1000 Mbps
Duplex: full
Link Failure Count: 0
Permanent HW addr: 10:60:4b:9c:a2:a4
Slave queue ID: 0
[root@s003 ~]#
#+END_SRC

* TODO bond.options with Mode 4(802.3ad)

- https://docs.rackspace.com/blog/lacp-bonding-and-linux-configuration/
- https://access.redhat.com/solutions/71883
- http://www.uni-koeln.de/~pbogusze/posts/LACP_configuration_using_iproute2.html
- https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-using_channel_bonding
- https://backdrift.org/lacp-configure-network-bonding-linux
- https://help.onapp.com/hc/en-us/articles/222048108-LACP-4-NICS-bond-Mode-4-traffic-goes-through-1-NIC-instead-of-4

- xmit_hash_policy

| types    | desc                     | note           |
|----------+--------------------------+----------------|
| layer2   | src and dest mac         | default policy |
| layer2+3 | src and dest mac and ip  |                |
| layer3+4 | src and dest port and ip |                |

#+BEGIN_SRC 
? nmcli con mod id bond0 bond.options mode=802.3ad,miimon=100,lacp_rate=fast,xmit_hash_policy=layer2+3
? nmcli con mod id bond0 802-3-ethernet.mtu 9000
#+END_SRC

#+BEGIN_SRC 
BONDING_OPTS="miimon=100 mode=802.3ad lacp_rate=fast xmit_hash_policy=layer2+3"
BONDING_OPTS="mode=802.3ad lacp_rate=fast xmit_hash_policy=layer2+3"
BONDING_OPTS="mode=802.3ad lacp_rate=fast"
BONDING_OPTS="mode=802.3ad"
BONDING_OPTS="miimon=100 mode=802.3ad"
#+END_SRC

https://help.onapp.com/hc/en-us/articles/222048108-LACP-4-NICS-bond-Mode-4-traffic-goes-through-1-NIC-instead-of-4

#+BEGIN_SRC 
? ifdown onappstorebond 
? "layer3+4" > /sys/class/net/onappstorebond/bonding/xmit_hash_policy 
? ifup onappstorebond 
#+END_SRC

#+BEGIN_SRC 
modprobe bonding miimono=100 mode=802.3ad lacp_rate=slow

ip link set dev eth0 down
ip link set dev eth1 down
ip link set dev bond0 down

ip link set dev eth0 master bond0
ip link set dev eth1 master bond0

ip link set dev eth0 up
ip link set dev eth1 up
ip link set dev bond0 up

ip link set bond0 up

ifenslave bond0 eth0 eth1

dmesg
#+END_SRC

#+BEGIN_SRC 
show lacp nei
#+END_SRC

* DONE lacp_rate

- slow: check lacp nei every 30 sec, default value
- fast: every 1 sec

* DONE miimon=time_in_milliseconds

- 0: default, off
- 100: starting point

* TODO so

BONDING_OPTS="miimon=100 mode=802.3ad lacp_rate=fast xmit_hash_policy=layer2+3"

nmcli con mod id bond0 bond.options mode=802.3ad,miimon=100,lacp_rate=fast,xmit_hash_policy=layer2+3
nmcli con mod id bond0 802-3-ethernet.mtu 9000

modprobe bonding miimono=100 mode=802.3ad lacp_rate=slow

nmcli connection down bridge0

ip link set virbr0 down
ip link set bridge0 down
ip link set enp0s8 down
ip link set enp0s9 down
ip link set bond0 down

ip link delete virbr0
ip link delete bridge0

ip link add bond0 type bond
ip link add br0 type bridge

ip link set enp0s8 master bond0
ip link set enp0s9 master bond0

ip link set enp0s8 up
ip link set enp0s9 up

ip link set bond0 up

ifenslave bond0 eth0 eth1

systemctl status NetworkManager

ip addr add 192.168.123.133 dev bond0

* logs

- br0: received packet on eth0 with own address as source address

* TODO using nmcli about bond

- https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-network_bonding_using_the_networkmanager_command_line_tool_nmcli

** pre

# ONBOOT=no
nmcli connection down nic1
nmcli connection down nic2
nmcli connection modify id nic1 connection.autoconnect no
nmcli -g connection.autoconnect connection show nic1
cat /etc/sysconfig/network-scripts/ifcfg-nic1 | grep -i onboot
nmcli connection modify id nic2 connection.autoconnect no
nmcli -g connection.autoconnect connection show nic2
cat /etc/sysconfig/network-scripts/ifcfg-nic2 | grep -i onboot
nmcli connection

** active 

nmcli connection add type bond ifname cluster0 con-name cluster0
# nmcli connection add type bond ifname cluster0 con-name cluster0 ipv4.method none
nmcli -g bond.options connection show cluster0
nmcli connection modify id cluster0 bond.options mode=1,miimon=100
nmcli -g bond.options connection show cluster0

# nmcli con mod id cluster0 bond.options mode=802.3ad,miimon=100,lacp_rate=fast,xmit_hash_policy=layer2+3
# nmcli con mod id cluster0 802-3-ethernet.mtu 9000
nmcli connection add type ethernet ifname eth0 con-name cluster0-slave-eth0 master cluster0
nmcli connection add type ethernet ifname eth1 con-name cluster0-slave-eth1 master cluster0

nmcli connection
nmcli device
ip -br a
cat /proc/net/bonding/cluster0
sleep 3
ping -c 3 8.8.8.8

** deactive

nmcli connection down cluster0-slave-eth0
nmcli connection down cluster0-slave-eth1
nmcli connection delete cluster0-slave-eth0
nmcli connection delete cluster0-slave-eth1
nmcli connection down cluster0
sleep 1
nmcli connection delete cluster0
nmcli connection
nmcli device
ip -br a
cat /proc/net/bonding/cluster0
ping -c 3 8.8.8.8

** as ever, restore

nmcli connection modify id nic1 connection.autoconnect yes
nmcli -g connection.autoconnect connection show nic1
cat /etc/sysconfig/network-scripts/ifcfg-nic1 | grep -i onboot
nmcli connection modify id nic2 connection.autoconnect yes
nmcli -g connection.autoconnect connection show nic2
cat /etc/sysconfig/network-scripts/ifcfg-nic2 | grep -i onboot

nmcli connection up nic1
nmcli connection up nic2

nmcli connection

** chk

nmcli c
nmcli d
ip -br a
ip r

* TODO then using nmcli about bridge

- https://www.cyberciti.biz/faq/how-to-add-network-bridge-with-nmcli-networkmanager-on-linux/

** pre

# ONBOOT=no
nmcli connection down nic1
nmcli connection down nic2
nmcli connection modify id nic1 connection.autoconnect no
nmcli -g connection.autoconnect connection show nic1
cat /etc/sysconfig/network-scripts/ifcfg-nic1 | grep -i onboot
nmcli connection modify id nic2 connection.autoconnect no
nmcli -g connection.autoconnect connection show nic2
cat /etc/sysconfig/network-scripts/ifcfg-nic2 | grep -i onboot
nmcli connection

** active

nmcli connection add type bridge con-name clusterbr
nmcli connection add type bridge-slave ifname eth0 con-name clusterbr-slave-eth0 master clusterbr

nmcli connection
nmcli device
ip -br a


** deactive

nmcli connection down clusterbr-slave-eth0
nmcli connection down clusterbr
sleep 1
nmcli connection delete clusterbr-slave-eth0
nmcli connection delete clusterbr

nmcli connection
# connecting (getting IP configuration) then connected
nmcli device
ip -br a

* DONE combined all using nmcli with bond and bridge, ip later on
  CLOSED: [2022-09-01 목 14:55]

** active

   #+begin_src 
nmcli connection add type bond ifname cluster0 con-name cluster0 ipv4.method disabled ipv6.method ignore
nmcli -g bond.options connection show cluster0
nmcli connection modify id cluster0 bond.options mode=1,miimon=100
nmcli -g bond.options connection show cluster0

# nmcli con mod id cluster0 bond.options mode=802.3ad,miimon=100,lacp_rate=fast,xmit_hash_policy=layer2+3
# nmcli con mod id cluster0 802-3-ethernet.mtu 9000
nmcli connection add type ethernet ifname eth0 con-name cluster0-slave-eth0 master cluster0
nmcli connection add type ethernet ifname eth1 con-name cluster0-slave-eth1 master cluster0

# nmcli connection
# nmcli device
# ip -br a
# cat /proc/net/bonding/cluster0
# sleep 3
# ping -c 3 8.8.8.8

nmcli connection add type bridge con-name clusterbr

# nmcli connection add type bridge con-name clusterbr \
# ipv4.method disabled ipv6.method ignore

# nmcli connection add type bridge con-name clusterbr \
# ipv4.method static ipv4.address 192.168.25.200/24 ipv4.gateway 192.168.25.1 \
# ipv4.dns 192.168.25.211 \
# ipv6.method ignore

# nmcli connection add type bridge-slave ifname cluster0 con-name clusterbr-slave-cluster0 master clusterbr

# nmcli connection modify cluster0 slave-type bridge master clusterbr
nmcli connection modify cluster0 master clusterbr slave-type bridge

systemctl restart network

# yum install bridge-utils

# nmcli connection
# nmcli device
# ip -br a
# brctl show
# bridge fdb
# ping 8.8.8.8

   #+end_src

** DONE active but slim
   CLOSED: [2022-09-01 목 14:55]

   #+begin_src 
nmcli connection add type bond ifname cluster0 con-name cluster0 ipv4.method disabled ipv6.method ignore
nmcli connection add type ethernet ifname eth0 con-name cluster0-slave-eth0 master cluster0
nmcli connection add type ethernet ifname eth1 con-name cluster0-slave-eth1 master cluster0
nmcli connection add type bridge con-name clusterbr
# nmcli connection add type bridge con-name clusterbr \
# ipv4.method static ipv4.address 192.168.25.200/24 ipv4.gateway 192.168.25.1 \
# ipv4.dns 192.168.25.211 \
# ipv6.method ignore
nmcli connection modify cluster0 master clusterbr slave-type bridge
nmcli connection up cluster0

   #+end_src
** DONE deactive
   CLOSED: [2022-09-01 목 14:55]

   #+begin_src 
nmcli connection down clusterbr
sleep 1
nmcli connection delete clusterbr
nmcli connection delete cluster0
nmcli connection delete cluster0-slave-eth0
nmcli connection delete cluster0-slave-eth1

   #+end_src

** chk

   #+begin_src 
brctl show
nmcli device
ip a
ip r
ping 8.8.8.8
   
   #+end_src


